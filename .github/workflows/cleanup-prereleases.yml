name: Cleanup Old Prereleases

on:
  workflow_dispatch: # Manual trigger only

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Delete Old Releases
        uses: actions/github-script@v7
        with:
          script: |
            // 1. Calculate the cutoff date (2 months ago)
            const cutoffDate = new Date();
            cutoffDate.setMonth(cutoffDate.getMonth() - 2);
            console.log(`üìÖ Cutoff date: ${cutoffDate.toISOString()}`);

            // 2. Fetch all releases
            const releases = await github.paginate(github.rest.repos.listReleases, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            console.log(`üîç Total releases found: ${releases.length}`);

            let deletedCount = 0;

            // 3. Iterate through releases
            for (const release of releases) {
              const releaseDate = new Date(release.created_at);
              const name = release.name || "";
              const tag = release.tag_name || "";
              
              // Check for keywords: "Prerelease" or "Beta" (case-insensitive just in case)
              const hasKeywords = /(Prerelease|Beta)/i.test(name) || /(Prerelease|Beta)/i.test(tag);
              
              // Check if older than cutoff
              const isOld = releaseDate < cutoffDate;

              if (hasKeywords && isOld) {
                console.log(`üóëÔ∏è DELETING Release: "${name}" (Tag: ${tag}) | Created: ${release.created_at}`);
                
                try {
                  // Delete the release entry
                  await github.rest.repos.deleteRelease({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    release_id: release.id
                  });
                  console.log(`   ‚úÖ Release deleted.`);

                  // Delete the git tag associated with it (optional but recommended for clean cleanup)
                  try {
                    await github.rest.git.deleteRef({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      ref: `tags/${tag}`
                    });
                    console.log(`   ‚úÖ Tag "${tag}" deleted.`);
                  } catch (tagError) {
                    console.log(`   ‚ö†Ô∏è Could not delete tag "${tag}" (might not exist or protected): ${tagError.message}`);
                  }

                  deletedCount++;
                } catch (error) {
                  console.log(`   ‚ùå Error deleting release ${name}: ${error.message}`);
                }
              }
            }

            console.log(`üèÅ Cleanup finished. Total deleted: ${deletedCount}`);